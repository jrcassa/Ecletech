<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Ecletech</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/_template_base.css">

</head>

<body>
    <div class="toast-container" id="toastContainer"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">E</div>
            <h2>Ecletech</h2>
        </div>

        <div class="sidebar-scroll">
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <a href="./home.html" class="active">
                        <div class="menu-item-content">
                            <span class="icon"><i class="fas fa-home"></i></span>
                            <span>Home</span>
                        </div>
                    </a>
                    <a href="./frotas.html" data-permission="frota.visualizar">
                        <div class="menu-item-content">
                            <span class="icon"><i class="fas fa-car"></i></span>
                            <span>Frotas</span>
                        </div>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Cadastros</div>

                    <button class="submenu-toggle" onclick="toggleSubmenu('cadastros-submenu', this)">
                        <div class="menu-item-content">
                            <span class="icon"><i class="fas fa-database"></i></span>
                            <span>Cadastros Gerais</span>
                        </div>
                        <i class="fas fa-chevron-down submenu-arrow"></i>
                    </button>
                    <div class="submenu" id="cadastros-submenu">
                        <a href="./estados.html" data-permission="estado.visualizar">
                            <div class="menu-item-content">
                                <span class="icon"><i class="fas fa-map"></i></span>
                                <span>Estados</span>
                            </div>
                        </a>
                        <a href="./cidades.html" data-permission="cidade.visualizar">
                            <div class="menu-item-content">
                                <span class="icon"><i class="fas fa-city"></i></span>
                                <span>Cidades</span>
                            </div>
                        </a>
                        <a href="./situacoes_vendas.html" data-permission="situacao_venda.visualizar">
                            <div class="menu-item-content">
                                <span class="icon"><i class="fas fa-chart-line"></i></span>
                                <span>Situações de Vendas</span>
                            </div>
                        </a>
                        <a href="./tipos_enderecos.html" data-permission="tipo_endereco.visualizar">
                            <div class="menu-item-content">
                                <span class="icon"><i class="fas fa-map-marker-alt"></i></span>
                                <span>Tipos de Endereços</span>
                            </div>
                        </a>
                        <a href="./tipos_contatos.html" data-permission="tipo_contato.visualizar">
                            <div class="menu-item-content">
                                <span class="icon"><i class="fas fa-phone"></i></span>
                                <span>Tipos de Contatos</span>
                            </div>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Gestão</div>
                    <a href="./colaboradores.html" data-permission="colaboradores.visualizar">
                        <div class="menu-item-content">
                            <span class="icon"><i class="fas fa-users"></i></span>
                            <span>Colaboradores</span>
                        </div>
                    </a>
                    <a href="./colaborador_management.html" data-permission="permissoes.visualizar,roles.visualizar">
                        <div class="menu-item-content">
                            <span class="icon"><i class="fas fa-user-shield"></i></span>
                            <span>Gestão de Acessos</span>
                        </div>
                    </a>
                    <a href="./loja.html" data-permission="loja.visualizar">
                        <div class="menu-item-content">
                            <span class="icon"><i class="fas fa-store"></i></span>
                            <span>Informações da Loja</span>
                        </div>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Administração</div>

                    <button class="submenu-toggle" onclick="toggleSubmenu('admin-submenu', this)">
                        <div class="menu-item-content">
                            <span class="icon"><i class="fas fa-tools"></i></span>
                            <span>Ferramentas</span>
                        </div>
                        <i class="fas fa-chevron-down submenu-arrow"></i>
                    </button>
                    <div class="submenu" id="admin-submenu">
                        <a href="./brute_force.html" data-permission="auditoria.visualizar">
                            <div class="menu-item-content">
                                <span class="icon"><i class="fas fa-shield-alt"></i></span>
                                <span>Proteção Brute Force</span>
                            </div>
                        </a>
                        <a href="./auditoria.html" data-permission="auditoria.visualizar">
                            <div class="menu-item-content">
                                <span class="icon"><i class="fas fa-clipboard-list"></i></span>
                                <span>Auditoria</span>
                            </div>
                        </a>
                    </div>
                </div>
            </nav>
        </div>

        <div class="sidebar-footer">
            <div class="user-info-sidebar" id="userInfoDropdown">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <div class="user-name" id="userNameSidebar">Carregando...</div>
                    <div class="user-role" id="userRoleSidebar">Usuário</div>
                </div>
                <i class="fas fa-chevron-down user-dropdown-arrow"></i>

                <div class="user-dropdown-menu" id="userDropdownMenu">
                    <a href="./perfil.html" class="user-dropdown-item">
                        <i class="fas fa-user"></i>
                        <span>Meu Perfil</span>
                    </a>
                    <a href="./configuracoes.html" class="user-dropdown-item">
                        <i class="fas fa-cog"></i>
                        <span>Configurações</span>
                    </a>
                    <div class="user-dropdown-item"
                        style="border-top: 1px solid #f1f5f9; margin-top: 4px; padding-top: 14px;"></div>
                    <button class="user-dropdown-item danger" id="logoutBtnSidebar">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sair da Conta</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="main-content" id="mainContent">
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Ecletech</h1>
            </div>
            <!-- Adicionando botão de toggle de tema e agrupando botões no header-right -->
            <div class="header-right">
                <button class="theme-toggle" id="themeToggle" title="Alternar tema">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="btn-logout" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </header>

        <div class="container">
            <div class="welcome-card">
                <h2 id="welcomeMessage">Bem-vindo!</h2>
                <p>Aqui estão as informações da sua conta</p>
            </div>

            <div id="loadingContainer" class="loading-container">
                <div class="spinner"></div>
            </div>

            <div id="errorContainer" class="error-container" style="display: none;">
                <p id="errorMessage"></p>
            </div>

            <div id="userInfoCard" class="user-info-card" style="display: none;">
                <h3>Dados do Usuário</h3>
                <div id="infoGrid" class="info-grid"></div>
            </div>

            <div class="user-info-card" id="rawDataCard" style="display: none; margin-top: 32px;">
                <h3>Dados Brutos (JSON)</h3>
                <pre id="rawData" class="json-viewer"></pre>
            </div>
        </div>
    </div>

    <script src="js/API.js"></script>
    <script src="js/Auth.js"></script>
    <script src="js/sidebar.js"></script>
    <script>
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        const htmlElement = document.documentElement;

        // Carregar tema salvo do localStorage
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                htmlElement.setAttribute('data-theme', 'dark');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                htmlElement.setAttribute('data-theme', 'light');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        }

        // Alternar tema
        function toggleTheme() {
            const currentTheme = htmlElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            htmlElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            if (newTheme === 'dark') {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        }

        // Event listener para o botão de tema
        themeToggle.addEventListener('click', toggleTheme);

        // Carregar tema ao iniciar
        loadTheme();


        const userInfoDropdown = document.getElementById('userInfoDropdown');
        const userDropdownMenu = document.getElementById('userDropdownMenu');
        const logoutBtnSidebar = document.getElementById('logoutBtnSidebar');

        userInfoDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
            userInfoDropdown.classList.toggle('open');
            userDropdownMenu.classList.toggle('show');
        });

        document.addEventListener('click', () => {
            userInfoDropdown.classList.remove('open');
            userDropdownMenu.classList.remove('show');
        });

        userDropdownMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        logoutBtnSidebar.addEventListener('click', async () => {
            if (confirm('Tem certeza que deseja sair?')) {
                await AuthAPI.logout();
            }
        });

        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const menuToggle = document.getElementById('menuToggle');
        const mainContent = document.getElementById('mainContent');

        function toggleSidebar() {
            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('show');
            } else {
                sidebar.classList.toggle('closed');
                mainContent.classList.toggle('expanded');
            }
        }

        menuToggle.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('show');
            }
        });

        function toggleSubmenu(submenuId, button) {
            const submenu = document.getElementById(submenuId);
            const isOpen = submenu.classList.contains('open');

            document.querySelectorAll('.submenu').forEach(sm => {
                sm.classList.remove('open');
            });
            document.querySelectorAll('.submenu-toggle').forEach(btn => {
                btn.classList.remove('open');
            });

            if (!isOpen) {
                submenu.classList.add('open');
                button.classList.add('open');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const activeLink = document.querySelector('.sidebar-nav a.active');
            if (activeLink) {
                const submenu = activeLink.closest('.submenu');
                if (submenu) {
                    submenu.classList.add('open');
                    const toggleButton = submenu.previousElementSibling;
                    if (toggleButton && toggleButton.classList.contains('submenu-toggle')) {
                        toggleButton.classList.add('open');
                    }
                }
            }
        });
    </script>
    <script>
        const loadingContainer = document.getElementById('loadingContainer');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const userInfoCard = document.getElementById('userInfoCard');
        const infoGrid = document.getElementById('infoGrid');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const rawDataCard = document.getElementById('rawDataCard');
        const rawData = document.getElementById('rawData');
        const logoutBtn = document.getElementById('logoutBtn');

        function showError(message) {
            loadingContainer.style.display = 'none';
            errorContainer.style.display = 'block';
            errorMessage.textContent = message;
            userInfoCard.style.display = 'none';
            rawDataCard.style.display = 'none';
        }

        function showUserData(user) {
            loadingContainer.style.display = 'none';
            errorContainer.style.display = 'none';
            userInfoCard.style.display = 'block';
            rawDataCard.style.display = 'block';

            const nome = user.nome || user.name || user.email?.split('@')[0] || 'Usuário';
            welcomeMessage.textContent = `Bem-vindo, ${nome}!`;

            infoGrid.innerHTML = '';

            const campos = [
                { key: 'id', label: 'ID' },
                { key: 'nome', label: 'Nome' },
                { key: 'email', label: 'E-mail' },
                { key: 'telefone', label: 'Telefone' },
                { key: 'cpf', label: 'CPF' },
                { key: 'idioma', label: 'Idioma' },
                { key: 'email_validado', label: 'Email Validado', type: 'boolean' },
                { key: 'ativo', label: 'Ativo', type: 'boolean' },
                { key: 'tipo_usuario', label: 'Tipo de Usuário' },
                { key: 'data_criacao', label: 'Data de Criação', type: 'date' },
                { key: 'data_atualizacao', label: 'Última Atualização', type: 'date' }
            ];

            campos.forEach(campo => {
                if (user[campo.key] !== undefined && user[campo.key] !== null) {
                    const item = document.createElement('div');
                    item.className = 'info-item';

                    const label = document.createElement('label');
                    label.textContent = campo.label;

                    const value = document.createElement('div');
                    value.className = 'value';

                    if (campo.type === 'boolean') {
                        const badge = document.createElement('span');
                        badge.className = `badge ${user[campo.key] == 1 ? 'badge-success' : 'badge-warning'}`;
                        badge.textContent = user[campo.key] == 1 ? 'Sim' : 'Não';
                        value.appendChild(badge);
                    } else if (campo.type === 'date') {
                        const date = new Date(user[campo.key]);
                        value.textContent = date.toLocaleString('pt-BR');
                    } else {
                        value.textContent = user[campo.key];
                    }

                    item.appendChild(label);
                    item.appendChild(value);
                    infoGrid.appendChild(item);
                }
            });

            Object.keys(user).forEach(key => {
                if (!campos.find(c => c.key === key)) {
                    const item = document.createElement('div');
                    item.className = 'info-item';

                    const label = document.createElement('label');
                    label.textContent = key.replace(/_/g, ' ').toUpperCase();

                    const value = document.createElement('div');
                    value.className = 'value';

                    const val = user[key];
                    if (typeof val === 'object' && val !== null) {
                        value.textContent = JSON.stringify(val, null, 2);
                    } else {
                        value.textContent = val;
                    }

                    item.appendChild(label);
                    item.appendChild(value);
                    infoGrid.appendChild(item);
                }
            });

            rawData.textContent = JSON.stringify(user, null, 2);
        }

        // Carrega dados do usuário para exibição na página home
        async function loadHomeUserData() {
            try {
                if (!AuthAPI.isAuthenticated()) {
                    window.location.href = './auth.html';
                    return;
                }

                const user = await AuthAPI.getMe();

                if (user) {
                    showUserData(user);
                } else {
                    showError('Não foi possível carregar os dados do usuário.');
                }

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showError('Erro ao carregar dados do usuário. Por favor, tente novamente.');
            }
        }

        logoutBtn.addEventListener('click', async () => {
            if (confirm('Tem certeza que deseja sair?')) {
                await AuthAPI.logout();
            }
        });

        loadHomeUserData();
    </script>
</body>

</html>
